// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = "file:./prisma/dev.db"
}

model Album {
  id           String      @id @default(uuid())
  title        String
  description  String?
  artistId     String?     // ID del usuario autenticado (puede ser número o UUID) - REFERENCIA A USUARIOS BD
  labelId      String?     // ID del label (puede ser número o UUID)
  releaseDate  DateTime?
  releaseState String // draft, scheduled, published, archived
  price        Float?
  currency     String?
  genres       String? // CSV de géneros
  tags         String? // CSV de tags
  cover        Image       @relation(fields: [coverId], references: [id])
  coverId      String      @unique // Relación uno a uno, clave única
  tracks       Track[]
  stats        AlbumStats?
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt
}

model Comment {
  id         String   @id @default(uuid())        // identificador único
  targetId   String                                // id del álbum, track, merch...
  targetType String                                // "album", "track", "merch"
  text       String?                               // texto opcional
  rating     Int?                                  // puntuación opcional
  userId     String?                               // usuario que comenta
  status     String   @default("visible")          // estado: visible/hidden/etc.
  createdAt  DateTime @default(now())              // fecha de creación
  updatedAt  DateTime @updatedAt                   // fecha de actualización
}

model Track {
  id          String      @id @default(uuid())
  title       String
  trackNumber Int
  durationSec Int
  album       Album       @relation(fields: [albumId], references: [id])
  albumId     String
  audio       Audio?
  lyrics      Lyrics?
  stats       TrackStats?
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
}

model Artist {
  id   String @id @default(uuid())
  name String
}

model Label {
  id   String @id @default(uuid())
  name String @unique
}

model Image {
  id        String     @id @default(uuid())
  alt       String?
  width     Int
  height    Int
  url       String
  album     Album?     @relation // Relación inversa con Album
}

model Audio {
  id      String @id @default(uuid())
  codec   String
  bitrate Int
  url     String
  track   Track  @relation(fields: [trackId], references: [id])
  trackId String @unique // Relación uno a uno, clave única
}

model Lyrics {
  id       String @id @default(uuid())
  language String
  text     String
  track    Track  @relation(fields: [trackId], references: [id])
  trackId  String @unique // Relación uno a uno, clave única
}

model AlbumStats {
  id           String  @id @default(uuid())
  playCount    Int
  likeCount    Int
  ratingAvg    Float
  commentCount Int
  album        Album?  @relation(fields: [albumId], references: [id])
  albumId      String? @unique // Relación uno a uno, clave única
}

model TrackStats {
  id        String @id @default(uuid())
  playCount Int
  track     Track  @relation(fields: [trackId], references: [id])
  trackId   String @unique // Relación uno a uno, clave única
}

model Favorite {
  id         String   @id @default(uuid())
  userId     String
  targetId   String
  targetType String
  createdAt  DateTime @default(now())

  @@index([userId, targetType])
}

enum MerchCategory {
  SHIRT
  HOODIE
  POSTER
  VINYL
  CD
  STICKER
  OTHER
}

model MerchItem {
  id          String        @id @default(uuid())
  title       String
  description String?
  category    MerchCategory @default(OTHER)

  // Guardar precios en céntimos es más robusto con SQLite
  priceCents Int
  currency   String @default("EUR")

  stock  Int     @default(0)
  sku    String? @unique
  active Boolean @default(true)

  // IDs de referencia a otros microservicios (sin FK, solo strings)
  artistId String? // ID del artista (puede ser número o UUID) - REFERENCIA A USUARIOS BD
  labelId  String?
  
  // Portada opcional como referencia simple (sin FK)
  coverId String? // ID de la imagen de portada (opcional, sin relación FK)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}
